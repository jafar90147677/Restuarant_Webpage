# Deploy ngrok as Docker Container

## Overview

This setup runs ngrok as a Docker container alongside Jenkins, ensuring both services start together and restart automatically.

## Benefits

‚úÖ **Auto-start**: Containers start automatically with Docker  
‚úÖ **Auto-restart**: Restarts automatically if containers crash  
‚úÖ **Consistent**: Both Jenkins and ngrok run in containers  
‚úÖ **Easy Management**: Start/stop with single command  
‚úÖ **No Manual Setup**: No need to run ngrok commands manually

## Quick Start

### Option 1: Simple Setup (Recommended)

1. **Start the stack:**
   ```powershell
   .\start-docker-stack.ps1
   ```

2. **That's it!** Both Jenkins and ngrok will start automatically.

### Option 2: Manual Docker Compose

```powershell
docker-compose -f docker-compose-simple.yml up -d
```

## Files Created

1. **`docker-compose-simple.yml`** - Main compose file (no auth token needed)
2. **`start-docker-stack.ps1`** - PowerShell script to start everything
3. **`ngrok.yml`** - ngrok config (with auth token support)
4. **`ngrok-simple.yml`** - Simple ngrok config (no auth token)

## Configuration

### Docker Compose Services

- **Jenkins**: Port 32768 ‚Üí 8080
- **ngrok**: Port 4040 (web interface)
- **Network**: Both services on `jenkins-network`

### ngrok Configuration

The ngrok container connects to Jenkins via Docker network:
- **Target**: `jenkins:8080` (internal Docker network)
- **Public URL**: Automatically generated by ngrok

## Usage

### Start Services
```powershell
.\start-docker-stack.ps1
```

### Stop Services
```powershell
docker-compose -f docker-compose-simple.yml down
```

### View Logs
```powershell
# All logs
docker-compose -f docker-compose-simple.yml logs -f

# Just ngrok logs
docker logs ngrok -f

# Just Jenkins logs
docker logs jenkins -f
```

### Get ngrok Public URL
```powershell
Invoke-RestMethod http://localhost:4040/api/tunnels | Select-Object -ExpandProperty tunnels | Select-Object -ExpandProperty public_url
```

### Check Status
```powershell
docker ps --filter "name=jenkins" --filter "name=ngrok"
```

## Auto-Start Configuration

### Docker Desktop Auto-Start

1. **Enable Docker Desktop auto-start:**
   - Docker Desktop ‚Üí Settings ‚Üí General
   - Check "Start Docker Desktop when you log in"

2. **Create startup script:**
   - Create shortcut to `start-docker-stack.ps1`
   - Add to Windows Startup folder

### Windows Startup Folder

1. Press `Win+R`, type: `shell:startup`
2. Create shortcut to `start-docker-stack.ps1`
3. Now it runs automatically on login

## Important Notes

‚ö†Ô∏è **ngrok URL Changes**: Each time the ngrok container restarts, the URL may change. Update GitHub webhook if needed.

üí° **Get Current URL**: 
- Web interface: `http://localhost:4040`
- API: `http://localhost:4040/api/tunnels`

‚ö†Ô∏è **Port Conflicts**: Ensure ports 32768, 4040, and 50000 are not in use.

## Troubleshooting

### Containers not starting?
```powershell
# Check Docker logs
docker-compose -f docker-compose-simple.yml logs

# Check if ports are in use
netstat -ano | findstr ":32768"
netstat -ano | findstr ":4040"
```

### ngrok not connecting?
- Verify Jenkins container is running: `docker ps | findstr jenkins`
- Check network: `docker network inspect jenkins-network`
- Check ngrok logs: `docker logs ngrok`

### Cannot access ngrok API?
- Wait a few seconds after starting (ngrok needs time to initialize)
- Check ngrok container is running: `docker ps | findstr ngrok`
- Verify port 4040 is accessible: `http://localhost:4040`

## Migration from Manual ngrok

If you were running ngrok manually:

1. **Stop manual ngrok process:**
   ```powershell
   Get-Process ngrok | Stop-Process
   ```

2. **Start Docker stack:**
   ```powershell
   .\start-docker-stack.ps1
   ```

3. **Update GitHub webhook** with new URL (if changed)

## Advanced Configuration

### Using ngrok Auth Token (Optional)

1. Get your ngrok authtoken from: https://dashboard.ngrok.com/get-started/your-authtoken

2. Update `docker-compose.yml`:
   ```yaml
   environment:
     - NGROK_AUTHTOKEN=your_token_here
   ```

3. Use `docker-compose.yml` instead of `docker-compose-simple.yml`

### Custom ngrok Config

Edit `ngrok.yml` or `ngrok-simple.yml` and mount it in docker-compose.

---

**Status**: Ready to deploy! Run `.\start-docker-stack.ps1` to start everything.

